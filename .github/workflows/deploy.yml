name: Deploy to GitHub Pages

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]

  # Trigger manually from Actions tab
  workflow_dispatch:

  # Trigger on schedule (Daily at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: computepulse

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: computepulse/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefer-offline

      - name: Build project
        run: |
          npm run build

      - name: Ensure data directory exists
        run: |
          # Copy data files from public/data to dist/data if they exist
          if [ -d "public/data" ]; then
            mkdir -p dist/data
            cp -r public/data/* dist/data/ 2>/dev/null || true
            echo "Data files copied from public/data/"
          else
            echo "public/data directory not found, creating empty data directory"
            mkdir -p dist/data
          fi

      - name: Create .nojekyll file
        run: |
          echo "Creating .nojekyll file for GitHub Pages"
          touch dist/.nojekyll

      - name: Verify build output
        run: |
          echo "=== Build Verification ==="
          echo "Checking dist directory structure:"
          ls -la dist/

          echo ""
          echo "=== Critical Files Check ==="
          if [ -f "dist/.nojekyll" ]; then
            echo "✅ .nojekyll file exists"
          else
            echo "❌ .nojekyll file missing - creating now"
            touch dist/.nojekyll
          fi

          if [ -f "dist/index.html" ]; then
            echo "✅ index.html exists"
            echo "Checking index.html base path:"
            grep -o 'href="/computepulse/[^"]*"' dist/index.html || echo "Warning: May not have correct base path"
          else
            echo "❌ index.html missing - build may have failed"
            exit 1
          fi

          if [ -d "dist/data" ]; then
            echo "✅ data directory exists"
            echo "Data files:"
            ls -la dist/data/ || echo "No data files found"
          else
            echo "⚠️  data directory missing - creating empty directory"
            mkdir -p dist/data
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: computepulse/dist
          branch: gh-pages
          clean: true
