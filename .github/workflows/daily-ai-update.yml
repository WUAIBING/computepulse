name: AI Daily Market Analysis

on:
  # Schedule: Run every 6 hours (adjust as needed)
  schedule:
    - cron: '0 */6 * * *'
  
  # Manual trigger button
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ai-analysis:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: computepulse

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas pytz python-dotenv openai dashscope

      - name: Run AI Analysis Scripts
        env:
          # Secrets must be configured in GitHub Repository Settings
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          echo "Starting AI Market Analysis..."
          # 1. Run the modular price fetcher (using AI Consortium: Qwen, DeepSeek, Kimi)
          python scripts/fetch_prices_modular.py
          
          # 2. (Optional) Run other specific analysis scripts
          # python scripts/generate_daily_report.py

      - name: Commit and Push Data Updates
        run: |
          git config --global user.name 'AI Orchestrator Bot'
          git config --global user.email 'bot@computepulse.ai'
          
          # Check if there are any changes to data files
          if [[ -n $(git status --porcelain public/data/) ]]; then
            echo "New data detected. Committing changes..."
            git add public/data/
            git commit -m "Data Update: AI Analysis completed [$(date -u +'%Y-%m-%d %H:%M UTC')]"
            git push
          else
            echo "No data changes detected."
          fi
